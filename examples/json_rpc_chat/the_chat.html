<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script type="text/javascript" src="/scripts/json2.js"></script>
	<script type="text/javascript" src="/scripts/jsonrpc.js"></script>
	<title>Chat Room</title>

	<script type="text/javascript">
		message_count = 0;
		rpc = new JsonRPC('/chat',['get'],['post']);

		function make_error(what,e)
		{
			document.getElementById('error_message').innerHTML = what + ': ' + e.type +': ' + e.error;
		}

		rpc.get.on_result = function(messages) {
			var messagesHtml = document.getElementById('messages');
			
			for(var i=0;i<messages.length;i++) {
				m=messages[i];
				messagesHtml.innerHTML+='<dt>' + m.author +'</dt>' +
					'<dd>' + m.message + '</dd>';
				message_count++;
			}
			//messagesHtml.innerHTML += '<p>JSON: ' +  JSON.stringify(messages) + '</p>' ;

			restart();
		}

		rpc.get.on_error = function(e) {
			make_error('Getting New Messages',e);
			document.getElementById('reconnect').disabled = false;
		}
	 
		rpc.post.on_error = function(e) {
			make_error('Posting New Messages',e);
		}
		rpc.post.on_result = function() {
			document.getElementById("message").value = '';
		}

		function restart()
		{
			rpc.get(message_count);
		}
		function reconnect_to_server()
		{
			message_count = 0;
			document.getElementById('error_message').innerHTML = '';
			restart();
			return false;
		}

		function send_data() {
			author = document.getElementById('author').value;
			message = document.getElementById("message").value;
			rpc.post(author,message);
			return false;
		}
	</script>


</head>
<body onload='restart()'>
<h1>Chat room</h1>
<form id="theform" >
	<p>Name: <input id="author" type="text" value="" /></p>
	<p>
	Message: <input id="message" type="text" value="" /></p>
	<input type="submit" value="Send" onclick="return send_data()"/>
	<input disabled="disabled" id='reconnect' type='submit' value='Reconnect' onclick='return reconnect_to_server()'>
	</p>
	<p id='error_message'></p>
</form>
<dl id="messages">
</dl>
</body>
